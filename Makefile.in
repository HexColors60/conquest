# Makefile for conquest - generated by configure from Makefile.in
#
#
# Jon Trulson
#
# $Id$
#
###########################################################################

# fun with autoconf
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
datadir = @datadir@
libdir = @libdir@
libexecdir = @libexecdir@
localstatedir = @localstatedir@
rlocalstatedir = $(localstatedir)/conquest
sysconfdir = @sysconfdir@

DIRTARGETS = $(exec_prefix) $(bindir) $(datadir) $(libdir) \
	     $(libexecdir) $(localstatedir) $(rlocalstatedir) $(sysconfdir)

# User defineable options
CONQGROUP = @CONQGROUP@
MAKE = make

# Unixware: try -Ki486 or -Kpentium -
#  might improve performance depending on processor type.
#LCFLAGS = -Kpentium

LCFLAGS = 

CFLAGS = @CFLAGS@ @DEFS@ $(LCFLAGS) -DCONQUEST_GROUP=\"$(CONQGROUP)\" \
	-DCONQSTATE=\"$(rlocalstatedir)\" -DCONQLIBEXEC=\"$(libexecdir)\" \
	-DCONQSHARE=\"$(datadir)\" -DCONQETC=\"$(sysconfdir)\"
CONQUEST = conquest
CONQAI = conqai
CONQOPER = conqoper
CONQDRIV = conqdriv
CONQSTRAT = conqstrat

# The documentation
CONQHELP = conquest.doc
CONQNEWS = conqnews.doc

CURDIR=.
CONQC = ratfor.c cd2lb.c display.c iolb.c  \
	conqlb.c rndlb.c conqmisc.c conqutil.c conqcm.c \
	conqsvr42.c global.c ibuf.c version.c conf.c sem.c color.c \
	userauth.c options.c

CONQOBJS = ratfor.o cd2lb.o display.o iolb.o  \
	conqlb.o rndlb.o conqmisc.o conqutil.o conqcm.o \
	conqsvr42.o global.o ibuf.o version.o conf.o sem.o color.o \
	userauth.o options.o

# For installation (needed so a build can be run in the build directory
#                   without contaminating an already installed game)
BCONQUEST = $(bindir)/conquest
BCONQOPER = $(bindir)/conqoper
BCONQDRIV = $(libexecdir)/conqdriv
BCONQAI = $(bindir)/conqai
BCONQSTRAT = $(bindir)/conqstrat
HCONQHELP = $(datadir)/$(CONQHELP)
HCONQNEWS = $(datadir)/$(CONQNEWS)
HCONQREADME = $(datadir)/conquest.README

CONQLB = @CONQLB@

EXTLBS = @LIBS@ @LEXLIB@ @YACCLIB@

LEX = @LEX@
YACC = @YACC@

# [shared|static] lib build options
LBFLAGS = @LBFLAGS@

# End of config options - No user servicable parts inside.
default:
	@echo "type gmake <target>, where <target> is:"
	@echo ""
	@echo "all        - make all the binaries"
	@echo "install    - to install the binaries (must be root)"
	@echo "clean      - to remove all .o's, libs, and binaries"
	@echo "realclean  - like clean, but removes configure genned files too"
	@echo "depend     - to make a dependancy list for your makefile."
	@echo "             Use 'gmake clean' before building if you are"
	@echo "             lacking a 'makedepend' command."

all: $(CONQLB) $(CONQUEST) $(CONQOPER) $(CONQAI) $(CONQDRIV) $(CONQSTRAT)

# program building  
##################

conquest: conquest.o 
	@-rm -f conquest
	$(CC) -o conquest $(CFLAGS) conquest.o $(CURDIR)/$(CONQLB) $(EXTLBS)
	@chgrp $(CONQGROUP) conquest
	@chmod 2771 conquest

conquest.o: conquest.c c_defs.h defs.h conqdef.h conqcom.h conqcom2.h
	$(CC) $(CFLAGS) -c conquest.c

conqdriv.o: conqdriv.c c_defs.h defs.h conqdef.h conqcom.h conqcom2.h
	$(CC) $(CFLAGS) -c conqdriv.c

conqdriv: conqdriv.o 
	@-rm -f conqdriv
	$(CC) -o conqdriv $(CFLAGS) conqdriv.o $(CURDIR)/$(CONQLB) $(EXTLBS)
	@chgrp $(CONQGROUP) conqdriv
	@chmod 2771 conqdriv

conqai: conqai.o 
	@-rm -f conqai
	$(CC) -o conqai $(CFLAGS) conqai.o $(CURDIR)/$(CONQLB) $(EXTLBS)
	@chgrp $(CONQGROUP) conqai
	@chmod 2771 conqai

conqai.o: conqai.c c_defs.h defs.h conqdef.h conqcom.h conqcom2.h conqdata.h
	$(CC) $(CFLAGS) -c -DCONQAIMAIN conqai.c 

conqai_nomain.o: conqai.c c_defs.h defs.h conqdef.h conqcom.h conqcom2.h conqdata.h
	$(CC) $(CFLAGS) -c conqai.c
	mv conqai.o conqai_nomain.o 

conqoper: conqoper.o 
	@-rm -f conqoper
	$(CC) -o conqoper $(CFLAGS) conqoper.o $(CURDIR)/$(CONQLB) $(EXTLBS)
	@chgrp $(CONQGROUP) conqoper
	@chmod 2771 conqoper

conqoper.o: conqoper.c c_defs.h defs.h conqdef.h conqcom.h conqcom2.h
	$(CC) $(CFLAGS) -c conqoper.c 

# we won't die if the following fails, since a default conqdata.h is supplied
conqstrat:  y.tab.o lex.yy.o
	-$(CC) -o conqstrat $(CFLAGS) lex.yy.o y.tab.o $(LIBS) $(CURDIR)/$(CONQLB) $(EXTLBS)

y.tab.c: conqstrat.c.y
	-$(YACC) -d conqstrat.c.y

y.tab.o: y.tab.c

lex.yy.c: conqstrat.c.l
	-$(LEX) conqstrat.c.l

lex.yy.o: lex.yy.c

# library building 
################

LBBUILD = @LBBUILD@

$(CONQLB): conqai_nomain.o $(CONQOBJS)
	$(LBBUILD) $(LBFLAGS) conqai_nomain.o $(CONQOBJS)
	@RANLIB@ $(CONQLB)

# Install it!
#############################

dirs: $(DIRTARGETS)

$(DIRTARGETS):
	mkdir -m 755 -p $(DIRTARGETS)
	chgrp $(CONQGROUP) $(rlocalstatedir)
	chmod 775 $(rlocalstatedir)

install: all dirs $(libdir)/$(CONQLB) $(BCONQUEST) $(BCONQOPER) $(BCONQDRIV) \
	$(HCONQHELP) $(HCONQNEWS) $(datadir)/conqrule $(BCONQSTRAT) \
	$(BCONQAI) $(sysconfdir)/conquestrc $(HCONQREADME)


$(libdir)/$(CONQLB): $(CONQLB)
	cp $(CONQLB) $(libdir)/$(CONQLB)
	chgrp $(CONQGROUP) $(libdir)/$(CONQLB)
	chmod 644 $(libdir)/$(CONQLB)

$(sysconfdir)/conquestrc: $(BCONQOPER)
	$(BCONQOPER) -C
	chmod 664 $(sysconfdir)/conquestrc
	chgrp $(CONQGROUP) $(sysconfdir)/conquestrc

$(BCONQUEST): conquest
	@-rm -f $(BCONQUEST)
	$(CC) -o conquest $(CFLAGS) conquest.o $(libdir)/$(CONQLB) $(EXTLBS)
	cp conquest $(BCONQUEST)
	chgrp $(CONQGROUP) $(BCONQUEST)
	chmod 2771 $(BCONQUEST)
	@FILEPRIV@ -f plock,tshar,core $(BCONQUEST)

$(BCONQOPER): conqoper
	@-rm -f $(BCONQOPER)
	$(CC) -o conqoper $(CFLAGS) conqoper.o $(libdir)/$(CONQLB) $(EXTLBS)
	cp conqoper $(BCONQOPER)
	chgrp $(CONQGROUP) $(BCONQOPER)
	chmod 2771 $(BCONQOPER)
	@FILEPRIV@ -f plock,tshar,core $(BCONQOPER)

$(BCONQDRIV): conqdriv
	@-rm -f $(BCONQDRIV)
	$(CC) -o conqdriv $(CFLAGS) conqdriv.o $(libdir)/$(CONQLB) $(EXTLBS)
	cp conqdriv $(BCONQDRIV)
	chgrp $(CONQGROUP) $(BCONQDRIV)
	chmod 2771 $(BCONQDRIV)
	@FILEPRIV@ -f plock,tshar,core $(BCONQDRIV)

$(BCONQAI): conqai
	@-rm -f $(BCONQAI)
	$(CC) -o conqai $(CFLAGS) conqai.o $(libdir)/$(CONQLB) $(EXTLBS)
	cp conqai $(BCONQAI)
	chgrp $(CONQGROUP) $(BCONQAI)
	chmod 2770 $(BCONQAI)
	@FILEPRIV@ -f plock,tshar,core $(BCONQAI)	

$(BCONQSTRAT): conqstrat
	@-rm -f $(BCONQSTRAT)
	-$(CC) -o conqstrat $(CFLAGS) lex.yy.o y.tab.o $(LIBS) $(libdir)/$(CONQLB) $(EXTLBS)
	-cp conqstrat $(BCONQSTRAT)
	-chgrp $(CONQGROUP) $(BCONQSTRAT)
	-chmod 751 $(BCONQSTRAT)

$(datadir)/conqrule: conqrule
	cp conqrule $(datadir)/conqrule
	chgrp $(CONQGROUP) $(datadir)/conqrule
	chmod 644 $(datadir)/conqrule

$(HCONQREADME): README
	cp README $(HCONQREADME)
	chgrp $(CONQGROUP) $(HCONQREADME)
	chmod 644 $(HCONQREADME)

$(HCONQHELP): $(CONQHELP)
	cp $(CONQHELP) $(HCONQHELP)
	chgrp $(CONQGROUP) $(HCONQHELP)
	chmod 644 $(HCONQHELP)

$(HCONQNEWS): $(CONQNEWS)
	cp $(CONQNEWS) $(HCONQNEWS)
	chgrp $(CONQGROUP) $(HCONQNEWS)
	chmod 644 $(HCONQNEWS)

clean:
	rm -f *.o $(CONQUEST) $(CONQOPER) $(CONQAI) $(CONQDRIV) \
		$(CONQLB) $(CONQSTRAT) y.tab.[ch] lex.yy.[c]

realclean:
	$(MAKE) clean
	rm -f config.status config.cache Makefile config.h

depend: 
	makedepend -s "# DO NOT DELETE - MAKEDEPEND" -- *.h -- *.c >/dev/null 2>&1


